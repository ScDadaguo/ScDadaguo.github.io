---
layout: post
title: 测试博客
category: test
tags: [test]
---

Docker(四)：使用 Docker 部署 Spring Boot', NULL, 1551058910, 1551058910, '      \r\n\r\nDocker(四)：使用 Docker 部署 Spring Boot\r\n==========================================\r\n\r\n\r\n\r\nDocker 技术发展为微服务落地提供了更加便利的环境，使用 Docker 部署 Spring Boot 其实非常简单，这篇文章我们就来简单学习下。\r\n\r\n首先构建一个简单的 Spring Boot 项目，然后给项目添加 Docker 支持，最后对项目进行部署。\r\n\r\n一个简单 Spring Boot 项目\r\n-------------------\r\n\r\n在 `pom.xml` 中 ，使用 Spring Boot 2.0 相关依赖\r\n\r\n    <parent>\r\n    	<groupId>org.springframework.boot</groupId>\r\n    	<artifactId>spring-boot-starter-parent</artifactId>\r\n    	<version>2.0.0.RELEASE</version>\r\n    </parent>\r\n    \r\n\r\n添加 web 和测试依赖\r\n\r\n    <dependencies>\r\n         <dependency>\r\n    	<groupId>org.springframework.boot</groupId>\r\n    	<artifactId>spring-boot-starter-web</artifactId>\r\n        </dependency>\r\n    	<dependency>\r\n    		<groupId>org.springframework.boot</groupId>\r\n    		<artifactId>spring-boot-starter-test</artifactId>\r\n    		<scope>test</scope>\r\n    	</dependency>\r\n    </dependencies>\r\n    \r\n\r\n创建一个 DockerController，在其中有一个`index()`方法，访问时返回：`Hello Docker!`\r\n\r\n    @RestController\r\n    public class DockerController {\r\n    	\r\n        @RequestMapping(\"/\")\r\n        public String index() {\r\n            return \"Hello Docker!\";\r\n        }\r\n    }\r\n    \r\n\r\n启动类\r\n\r\n    @SpringBootApplication\r\n    public class DockerApplication {\r\n    \r\n    	public static void main(String[] args) {\r\n    		SpringApplication.run(DockerApplication.class, args);\r\n    	}\r\n    }\r\n    \r\n\r\n添加完毕后启动项目，启动成功后浏览器放问：`http://localhost:8080/`，页面返回：`Hello Docker!`，说明 Spring Boot 项目配置正常。\r\n\r\nSpring Boot 项目添加 Docker 支持\r\n--------------------------\r\n\r\n在 `pom.xml-properties` 中添加 Docker 镜像名称\r\n\r\n    <properties>\r\n    	<docker.image.prefix>springboot</docker.image.prefix>\r\n    </properties>\r\n    \r\n\r\nplugins 中添加 Docker 构建插件：\r\n\r\n    <build>\r\n    	<plugins>\r\n    		<plugin>\r\n    			<groupId>org.springframework.boot</groupId>\r\n    			<artifactId>spring-boot-maven-plugin</artifactId>\r\n    		</plugin>\r\n    		<!-- Docker maven plugin -->\r\n    		<plugin>\r\n    			<groupId>com.spotify</groupId>\r\n    			<artifactId>docker-maven-plugin</artifactId>\r\n    			<version>1.0.0</version>\r\n    			<configuration>\r\n    				<imageName>${docker.image.prefix}/${project.artifactId}</imageName>\r\n    				<dockerDirectory>src/main/docker</dockerDirectory>\r\n    				<resources>\r\n    					<resource>\r\n    						<targetPath>/</targetPath>\r\n    						<directory>${project.build.directory}</directory>\r\n    						<include>${project.build.finalName}.jar</include>\r\n    					</resource>\r\n    				</resources>\r\n    			</configuration>\r\n    		</plugin>\r\n    		<!-- Docker maven plugin -->\r\n    	</plugins>\r\n    </build>\r\n    \r\n\r\n在目录`src/main/docker`下创建 Dockerfile 文件，Dockerfile 文件用来说明如何来构建镜像。\r\n\r\n    FROM openjdk:8-jdk-alpine\r\n    VOLUME /tmp\r\n    ADD spring-boot-docker-1.0.jar app.jar\r\n    ENTRYPOINT [\"java\",\"-Djava.security.egd=file:/dev/./urandom\",\"-jar\",\"/app.jar\"]\r\n    \r\n\r\n这个 Dockerfile 文件很简单，构建 Jdk 基础环境，添加 Spring Boot Jar 到镜像中，简单解释一下:\r\n\r\n*   FROM ，表示使用 Jdk8 环境 为基础镜像，如果镜像不是本地的会从 DockerHub 进行下载\r\n*   VOLUME ，VOLUME 指向了一个`/tmp`的目录，由于 Spring Boot 使用内置的Tomcat容器，Tomcat 默认使用`/tmp`作为工作目录。这个命令的效果是：在宿主机的`/var/lib/docker`目录下创建一个临时文件并把它链接到容器中的`/tmp`目录\r\n*   ADD ，拷贝文件并且重命名\r\n*   ENTRYPOINT ，为了缩短 Tomcat 的启动时间，添加`java.security.egd`的系统属性指向`/dev/urandom`作为 ENTRYPOINT\r\n\r\n> 这样 Spring Boot 项目添加 Docker 依赖就完成了。\r\n\r\n构建打包环境\r\n------\r\n\r\n我们需要有一个 Docker 环境来打包 Spring Boot 项目，在 Windows 搭建 Docker 环境很麻烦，因此我这里以 Centos 7 为例。\r\n\r\n### 安装 Docker 环境\r\n\r\n安装\r\n\r\n    yum install docker\r\n    \r\n\r\n安装完成后，使用下面的命令来启动 docker 服务，并将其设置为开机启动：\r\n\r\n    service docker start\r\n    chkconfig docker on\r\n    \r\n    #LCTT 译注：此处采用了旧式的 sysv 语法，如采用CentOS 7中支持的新式 systemd 语法，如下：\r\n    systemctl  start docker.service\r\n    systemctl  enable docker.service\r\n    \r\n\r\n使用Docker 中国加速器\r\n\r\n    vi  /etc/docker/daemon.json\r\n    \r\n    #添加后：\r\n    {\r\n        \"registry-mirrors\": [\"https://registry.docker-cn.com\"],\r\n        \"live-restore\": true\r\n    }\r\n    \r\n\r\n重新启动docker\r\n\r\n    systemctl restart docker\r\n    \r\n\r\n输入`docker version` 返回版本信息则安装正常。\r\n\r\n### 安装JDK\r\n\r\n    yum -y install java-1.8.0-openjdk*\r\n    \r\n\r\n配置环境变量 打开 `vim /etc/profile` 添加一下内容\r\n\r\n    export JAVA_HOME=/usr/lib/jvm/java-1.8.0-openjdk-1.8.0.161-0.b14.el7_4.x86_64 \r\n    export PATH=$PATH:$JAVA_HOME/bin \r\n    \r\n\r\n修改完成之后，使其生效\r\n\r\n    source /etc/profile\r\n    \r\n\r\n输入`java -version` 返回版本信息则安装正常。\r\n\r\n### 安装MAVEN\r\n\r\n下载：`http://mirrors.shu.edu.cn/apache/maven/maven-3/3.5.2/binaries/apache-maven-3.5.2-bin.tar.gz`\r\n\r\n    ## 解压\r\n    tar vxf apache-maven-3.5.2-bin.tar.gz\r\n    ## 移动\r\n    mv apache-maven-3.5.2 /usr/local/maven3\r\n    \r\n\r\n修改环境变量， 在`/etc/profile`中添加以下几行\r\n\r\n    MAVEN_HOME=/usr/local/maven3\r\n    export MAVEN_HOME\r\n    export PATH=${PATH}:${MAVEN_HOME}/bin\r\n    \r\n\r\n记得执行`source /etc/profile`使环境变量生效。\r\n\r\n输入`mvn -version` 返回版本信息则安装正常。\r\n\r\n> 这样整个构建环境就配置完成了。\r\n\r\n使用 Docker 部署 Spring Boot 项目\r\n---------------------------\r\n\r\n将项目 `spring-boot-docker` 拷贝服务器中，进入项目路径下进行打包测试。\r\n\r\n    #打包\r\n    mvn package\r\n    #启动\r\n    java -jar target/spring-boot-docker-1.0.jar\r\n    \r\n\r\n看到 Spring Boot 的启动日志后表明环境配置没有问题，接下来我们使用 DockerFile 构建镜像。\r\n\r\n    mvn package docker:build\r\n    \r\n\r\n第一次构建可能有点慢，当看到以下内容的时候表明构建成功：\r\n\r\n    ...\r\n    Step 1 : FROM openjdk:8-jdk-alpine\r\n     ---> 224765a6bdbe\r\n    Step 2 : VOLUME /tmp\r\n     ---> Using cache\r\n     ---> b4e86cc8654e\r\n    Step 3 : ADD spring-boot-docker-1.0.jar app.jar\r\n     ---> a20fe75963ab\r\n    Removing intermediate container 593ee5e1ea51\r\n    Step 4 : ENTRYPOINT java -Djava.security.egd=file:/dev/./urandom -jar /app.jar\r\n     ---> Running in 85d558a10cd4\r\n     ---> 7102f08b5e95\r\n    Removing intermediate container 85d558a10cd4\r\n    Successfully built 7102f08b5e95\r\n    [INFO] Built springboot/spring-boot-docker\r\n    [INFO] ------------------------------------------------------------------------\r\n    [INFO] BUILD SUCCESS\r\n    [INFO] ------------------------------------------------------------------------\r\n    [INFO] Total time: 54.346 s\r\n    [INFO] Finished at: 2018-03-13T16:20:15+08:00\r\n    [INFO] Final Memory: 42M/182M\r\n    [INFO] ------------------------------------------------------------------------\r\n    \r\n\r\n使用`docker images`命令查看构建好的镜像：\r\n\r\n    docker images\r\n    REPOSITORY                      TAG                 IMAGE ID            CREATED             SIZE\r\n    springboot/spring-boot-docker   latest              99ce9468da74        6 seconds ago       117.5 MB\r\n    \r\n\r\n`springboot/spring-boot-docker` 就是我们构建好的镜像，下一步就是运行该镜像\r\n\r\n    docker run -p 8080:8080 -t springboot/spring-boot-docker\r\n    \r\n\r\n启动完成之后我们使用`docker ps`查看正在运行的镜像：\r\n\r\n    docker ps\r\n    CONTAINER ID        IMAGE                           COMMAND                  CREATED             STATUS              PORTS                    NAMES\r\n    049570da86a9        springboot/spring-boot-docker   \"java -Djava.security\"   30 seconds ago      Up 27 seconds       0.0.0.0:8080->8080/tcp   determined_mahavira\r\n    \r\n\r\n可以看到我们构建的容器正在在运行，访问浏览器：`http://192.168.0.x:8080/`,返回\r\n\r\n    Hello Docker!\r\n    \r\n\r\n说明使用 Docker 部署 Spring Boot 项目成功！\r\n\r\n**[示例代码-github](https://github.com/ityouknow/spring-boot-examples)**\r\n\r\n**[示例代码-码云](https://gitee.com/ityouknow/spring-boot-examples)**\r\n\r\n参考\r\n--\r\n\r\n[Spring Boot with Docker](https://spring.io/guides/gs/spring-boot-docker/)  \r\n[Docker：Spring Boot 应用发布到 Docker](https://lw900925.github.io/docker/docker-springboot.html)\r\n\r\n